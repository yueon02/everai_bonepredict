<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BonePredict - X-Ray Gender Determination</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        .sample-thumb {
            width: 200px; /* Increased from default */
            height: 200px; /* Increased from default */
            object-fit: cover; /* Ensures image scales properly */
            cursor: pointer;
            border-radius: 10px; /* Optional: Adds a rounded corner */
            transition: transform 0.2s; /* Smooth hover effect */
        }
        .sample-thumb:hover {
            transform: scale(1.05); /* Slight zoom on hover */
        }
    </style>
</head>
<body>
    <canvas id="dnaCanvas"></canvas>
    <div class="container">
    <div class="logout-container">
        <form action="{{ url_for('auth.logout') }}" method="get">
            <button type="submit" class="logout-btn" title="Logout">
                <i class="fas fa-right-from-bracket"></i>
            </button>
        </form>
    </div>
</div>
        <div class="header">
            <h1 id="logo">BonePredict</h1>
            <p>Advanced X-Ray Gender Determination System</p>
        </div>

        <div class="error-message" id="errorDisplay">
            <span class="error-icon">‚ö†Ô∏è</span>
            <div class="error-content">
                <strong id="errorTitle"></strong>
                <div id="errorHint" class="error-hint"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="analysis-section" id="analysisSection">
                <!-- Upload Section (Visible by default) -->
                <div class="upload-section" id="uploadSection">
                    <h2>Upload X-Ray Image</h2>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">
                                Drag and drop your X-ray image here<br>
                                or click to browse files
                            </div>
                            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <button class="upload-btn" onclick="document.getElementById('fileInput').click(); event.stopPropagation()">
                                    Choose File
                                </button>
                                <button class="sample-btn" onclick="showSampleModal(); event.stopPropagation();">
                                    Select Sample Image
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    <div class="format-info">
                        <p><strong>Supported formats:</strong> JPG, PNG (Max 5MB)</p>
                        <p><strong>Recommended:</strong> Clear skull X-rays with good contrast</p>
                    </div>
                </div>

                <!-- Sample Image Thumbnails -->
                <div id="sampleModal" style="display:none; text-align:center; margin-top: 20px;">
                    <p style="color:white;">Select one sample image below:</p>
                    <div style="display:flex; justify-content:center; gap:25px; flex-wrap:wrap; padding: 10px;">
                        <img src="/static/samples/sample1.jpg" onclick="handleSampleSelect(this)" class="sample-thumb">
                        <img src="/static/samples/sample2.jpg" onclick="handleSampleSelect(this)" class="sample-thumb">
                        <img src="/static/samples/sample3.jpeg" onclick="handleSampleSelect(this)" class="sample-thumb">
                    </div>
                </div>

                <!-- Results Section (Hidden by default) -->
                <div class="results-section" id="resultsSection">
                    <div class="results-header">
                        <h2>Analysis Results</h2>
                    </div>

                    <div class="results-flex">
                        <div class="image-preview" id="imagePreview">
                            <div class="placeholder-text">No image uploaded</div>
                        </div>

                        <div class="prediction-result" id="predictionResult">
                            <div class="prediction-icon" id="predictionIcon"></div>
                            <div class="prediction-text" id="predictionText"></div>
                            <div class="confidence-bar-container">
                                <div class="confidence-label">Confidence Level</div>
                                <div class="confidence-bar">
                                    <div class="confidence-bar-fill" id="confidenceBarFill"></div>
                                    <span class="confidence-value" id="confidenceValue"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="analyze-btn" id="analyzeBtn" disabled>
                        üîç Analyze X-Ray
                    </button>

                    <button class="upload-new-btn" id="backBtn" style="display: none;">
                        Analyze Another Image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null; // Moved to top for global scope

        document.addEventListener('DOMContentLoaded', function () {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const predictionResult = document.getElementById('predictionResult');
            const predictionIcon = document.getElementById('predictionIcon');
            const predictionText = document.getElementById('predictionText');
            const confidenceBarFill = document.getElementById('confidenceBarFill');
            const confidenceValue = document.getElementById('confidenceValue');
            const errorDisplay = document.getElementById('errorDisplay');
            const errorTitle = document.getElementById('errorTitle');
            const errorHint = document.getElementById('errorHint');
            const backBtn = document.getElementById('backBtn');
            const uploadSection = document.getElementById('uploadSection');
            const resultsSection = document.getElementById('resultsSection');

            resultsSection.style.display = 'none';

            function resetState() {
                predictionResult.style.display = 'none';
                predictionIcon.textContent = '';
                predictionText.textContent = '';
                confidenceBarFill.style.width = '0%';
                confidenceValue.textContent = '';
                hideError();
                analyzeBtn.textContent = 'üîç Analyze X-Ray';
                backBtn.style.display = 'none';
                // Do not clear uploadedFile here unless resetting to upload state
            }

            function showError(title, hint = '') {
                errorTitle.textContent = title;
                errorHint.textContent = hint;
                errorDisplay.classList.add('show');
                backBtn.style.display = 'inline-block';
            }

            function hideError() {
                errorDisplay.classList.remove('show');
            }

            function handleFileUpload(file) {
                if (!file.type.startsWith('image/')) {
                    showError('Invalid file type', 'Please upload a JPG or PNG image');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showError('File too large', 'Maximum file size is 5MB');
                    return;
                }

                uploadedFile = file;
                const reader = new FileReader();

                reader.onload = function (e) {
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Uploaded X-ray">`;
                    resetState();
                    uploadSection.style.display = 'none';
                    resultsSection.style.display = 'block';
                    runAnalysis(file);
                };

                reader.onerror = function (e) {
                    showError('File read error', 'Could not read the selected file');
                };

                reader.readAsDataURL(file);
            }

            uploadArea.addEventListener('click', function (e) {
                fileInput.click();
                e.stopPropagation();
            });

            uploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function () {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            backBtn.addEventListener('click', function () {
                uploadSection.style.display = 'block';
                resultsSection.style.display = 'none';
                uploadedFile = null; // Clear only when going back to upload
                resetState();
            });

            analyzeBtn.addEventListener('click', async function () {
                if (!uploadedFile) {
                    showError('No file selected', 'Please upload an X-ray image first');
                    return;
                }

                hideError();
                analyzeBtn.classList.add('processing');
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing...';

                try {
                    const formData = new FormData();
                    formData.append('xray', uploadedFile);

                    const response = await fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Analysis failed');
                    }

                    const result = await response.json();

                    if (result.success) {
                        predictionResult.className = `prediction-result ${result.gender}`;
                        predictionIcon.textContent = result.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                        predictionText.textContent = `Predicted: ${result.gender.charAt(0).toUpperCase() + result.gender.slice(1)}`;
                        const confidence = result.confidence;
                        confidenceBarFill.style.width = `${confidence}%`;
                        confidenceBarFill.style.backgroundColor = result.gender === 'male' ? '#4285f4' : '#dc6b82';
                        confidenceValue.textContent = `${confidence}%`;
                        predictionResult.style.display = 'flex';
                        analyzeBtn.textContent = 'üîç Analyze Again';
                        backBtn.style.display = 'inline-block';
                    } else {
                        showError(result.error, result.hint);
                    }
                } catch (error) {
                    showError('Analysis Error', error.message || 'Please try again later');
                } finally {
                    analyzeBtn.classList.remove('processing');
                    analyzeBtn.disabled = false;
                    if (predictionResult.style.display !== 'flex') {
                        analyzeBtn.textContent = 'üîç Analyze Again';
                    }
                }
            });

            resetState();
        });

        function runAnalysis(file) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const predictionResult = document.getElementById('predictionResult');
            const predictionIcon = document.getElementById('predictionIcon');
            const predictionText = document.getElementById('predictionText');
            const confidenceBarFill = document.getElementById('confidenceBarFill');
            const confidenceValue = document.getElementById('confidenceValue');
            const backBtn = document.getElementById('backBtn');

            const errorDisplay = document.getElementById('errorDisplay');
            const errorTitle = document.getElementById('errorTitle');
            const errorHint = document.getElementById('errorHint');

            function showError(title, hint = '') {
                errorTitle.textContent = title;
                errorHint.textContent = hint;
                errorDisplay.classList.add('show');
                backBtn.style.display = 'inline-block';
            }

            function hideError() {
                errorDisplay.classList.remove('show');
            }

            hideError();
            analyzeBtn.classList.add('processing');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';

            const formData = new FormData();
            formData.append('xray', file);

            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Analysis failed');
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    predictionResult.className = `prediction-result ${result.gender}`;
                    predictionIcon.textContent = result.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                    predictionText.textContent = `Predicted: ${result.gender.charAt(0).toUpperCase() + result.gender.slice(1)}`;
                    const confidence = result.confidence;
                    confidenceBarFill.style.width = `${confidence}%`;
                    confidenceBarFill.style.backgroundColor = result.gender === 'male' ? '#4285f4' : '#dc6b82';
                    confidenceValue.textContent = `${confidence}%`;
                    predictionResult.style.display = 'flex';
                    analyzeBtn.textContent = 'üîç Analyze Again';
                    backBtn.style.display = 'inline-block';
                } else {
                    showError(result.error, result.hint);
                }
            })
            .catch(error => {
                showError('Analysis Error', error.message || 'Please try again later');
            })
            .finally(() => {
                analyzeBtn.classList.remove('processing');
                analyzeBtn.disabled = false;
                if (predictionResult.style.display !== 'flex') {
                    analyzeBtn.textContent = 'üîç Analyze Again';
                }
            });
        }

        function showSampleModal() {
            const modal = document.getElementById('sampleModal');
            modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        }

        function handleSampleSelect(imgEl) {
            const src = imgEl.src;
            fetch(src)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], 'sample.jpg', { type: blob.type });
                    uploadedFile = file; // Set the global var once

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imagePreview = document.getElementById('imagePreview');
                        const sampleModal = document.getElementById('sampleModal');
                        const uploadSection = document.getElementById('uploadSection');
                        const resultsSection = document.getElementById('resultsSection');

                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Uploaded X-ray">`;
                        sampleModal.style.display = 'none';
                        uploadSection.style.display = 'none';
                        resultsSection.style.display = 'block';

                        runAnalysis(file); // Trigger initial analysis
                    };
                    reader.readAsDataURL(file);
                })
                .catch(error => {
                    showError('Sample Load Error', 'Failed to load sample image');
                });
        }
    </script>

    <script src="{{ url_for('static', filename='main.js') }}"></script>

    <script>
        const canvas = document.getElementById("dnaCanvas");
        const ctx = canvas.getContext("2d");

        let width, height;
        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // === CONFIG ===
        const dnaCount = 10;
        const basePairs = 20;
        const dnaParticles = [];

        let time = 0;

        function getRandomPastel() {
            const hues = [200, 300, 340, 180, 250];
            const hue = hues[Math.floor(Math.random() * hues.length)];
            return `hsl(${hue}, 100%, 85%)`;
        }

        // === Create DNA Particles ===
        for (let i = 0; i < dnaCount; i++) {
            const color1 = getRandomPastel();
            const color2 = getRandomPastel();

            const dna = {
                x: Math.random() * width,
                y: Math.random() * height,
                dx: (Math.random() - 0.5) * 0.3,
                dy: (Math.random() - 0.5) * 0.3,
                scale: 0.8 + Math.random() * 0.4,
                speedFactor: 0.8 + Math.random() * 0.5,
                amplitude: 10 + Math.random() * 10,
                color1,
                color2,
                alpha: 0.08 + Math.random() * 0.07,
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: Math.random() < 0.5 ? 0 : (Math.random() - 0.5) * 0.002,
                bubbles: []
            };

            // Generate small bubbles near this DNA strand
            for (let j = 0; j < 6 + Math.floor(Math.random() * 6); j++) {
                dna.bubbles.push({
                    xOffset: (Math.random() - 0.5) * 80,
                    yOffset: (Math.random() - 0.5) * 80,
                    r: 1 + Math.random() * 2,
                    dy: -0.05 - Math.random() * 0.1,
                    alpha: 0.04 + Math.random() * 0.05,
                    color: Math.random() < 0.5 ? color1 : color2
                });
            }

            dnaParticles.push(dna);
        }

        // === Draw DNA with base pairs ===
        function drawDNAHelix(px, py, scale, color1, color2, speedFactor, amplitude, alpha, rotation) {
            const verticalSpacing = 6 * scale;

            ctx.save();
            ctx.translate(px, py);
            ctx.rotate(rotation);
            ctx.scale(scale, scale);
            ctx.globalAlpha = alpha;

            for (let i = 0; i < basePairs; i++) {
                const y = i * verticalSpacing;
                const angle = (time * speedFactor + i) * 0.2;

                const x1 = Math.sin(angle) * amplitude;
                const x2 = Math.sin(angle + Math.PI) * amplitude;

                ctx.strokeStyle = "#ddddff";
                ctx.lineWidth = 1.2;
                ctx.beginPath();
                ctx.moveTo(x1, y);
                ctx.lineTo(x2, y);
                ctx.stroke();

                ctx.beginPath();
                ctx.fillStyle = color1;
                ctx.arc(x1, y, 2.5, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.fillStyle = color2;
                ctx.arc(x2, y, 2.5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }

        // === Draw and update DNA bubbles near the strand ===
        function drawDNABubbles(dna) {
            dna.bubbles.forEach(b => {
                // Calculate actual position relative to DNA strand center
                const bubbleX = dna.x + b.xOffset;
                const bubbleY = dna.y + b.yOffset;

                // Only draw if still within ~80px radius of the DNA strand center
                const distance = Math.sqrt((bubbleX - dna.x) ** 2 + (bubbleY - dna.y) ** 2);
                if (distance < 90) {
                    ctx.beginPath();
                    ctx.globalAlpha = b.alpha;
                    ctx.fillStyle = b.color;
                    ctx.arc(bubbleX, bubbleY, b.r, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Float upward slowly
                b.yOffset += b.dy;

                // Reset bubble if it floats too far from its origin
                if (b.yOffset < -80) {
                    b.yOffset = 80;
                    b.xOffset = (Math.random() - 0.5) * 80;
                }
            });
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);

            dnaParticles.forEach(p => {
                drawDNAHelix(p.x, p.y, p.scale, p.color1, p.color2, p.speedFactor, p.amplitude, p.alpha, p.rotation);
                drawDNABubbles(p);

                p.x += p.dx;
                p.y += p.dy;
                p.rotation += p.rotationSpeed;

                // Wrap around edges
                if (p.x < -100) p.x = width + 100;
                if (p.x > width + 100) p.x = -100;
                if (p.y < -100) p.y = height + 100;
                if (p.y > height + 100) p.y = -100;
            });

            time += 0.03;
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>